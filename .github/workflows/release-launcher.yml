name: Build Launcher Distribution Release

"on":
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      DISTRO_REPO: ${{ vars.FEH_DISTRO_REPO }}
      DISTRO_REPO_TOKEN: ${{ secrets.DISTRO_REPO_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install launcher dependencies
        run: npm ci --prefix launcher

      - name: Build launcher executable
        run: npm run build --prefix launcher

      - name: Prepare release bundles
        run: |
          mkdir -p release_build/app
          mkdir -p release_build/assets

          rsync -a \
            --exclude node_modules \
            --exclude .next \
            --exclude .env.local \
            app/ release_build/app/app/

          cp -R db release_build/assets/db

          cd release_build/app
          zip -r ../../feh-app-bundle.zip app
          cd ../assets
          zip -r ../../feh-assets-bundle.zip db

      - name: Validate release target token requirements
        if: env.DISTRO_REPO != '' && env.DISTRO_REPO != github.repository && env.DISTRO_REPO_TOKEN == ''
        run: |
          echo "::error::DISTRO_REPO_TOKEN secret is required when FEH_DISTRO_REPO targets a different repository."
          exit 1

      - name: Attach release assets (same repo fallback)
        if: env.DISTRO_REPO == '' || env.DISTRO_REPO == github.repository
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            dist/FEH-Barracks-Launcher.exe
            feh-app-bundle.zip
            feh-assets-bundle.zip
          generate_release_notes: true

      - name: Attach release assets (distribution repo)
        if: env.DISTRO_REPO != '' && env.DISTRO_REPO != github.repository && env.DISTRO_REPO_TOKEN != ''
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ env.DISTRO_REPO_TOKEN }}
          repository: ${{ env.DISTRO_REPO }}
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            dist/FEH-Barracks-Launcher.exe
            feh-app-bundle.zip
            feh-assets-bundle.zip
          generate_release_notes: true
