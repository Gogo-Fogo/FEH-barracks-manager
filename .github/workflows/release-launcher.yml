name: Build Launcher Distribution Release

"on":
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      DISTRO_REPO: ${{ vars.FEH_DISTRO_REPO }}
      DISTRO_REPO_TOKEN: ${{ secrets.DISTRO_REPO_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install launcher dependencies
        run: npm ci --prefix launcher

      - name: Build launcher executable
        run: npm run build --prefix launcher

      - name: Prepare release bundles
        env:
          VAR_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
          VAR_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SECRET_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SECRET_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          mkdir -p release_build/app

          rsync -a \
            --exclude node_modules \
            --exclude .next \
            --exclude .env.local \
            app/ release_build/app/app/

          SUPABASE_URL="$VAR_SUPABASE_URL"
          SUPABASE_ANON_KEY="$VAR_SUPABASE_ANON_KEY"

          if [ -z "$SUPABASE_URL" ]; then
            SUPABASE_URL="$SECRET_SUPABASE_URL"
          fi
          if [ -z "$SUPABASE_ANON_KEY" ]; then
            SUPABASE_ANON_KEY="$SECRET_SUPABASE_ANON_KEY"
          fi

          if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_ANON_KEY" ]; then
            cat > release_build/app/app/.env.local <<ENV
          NEXT_PUBLIC_SUPABASE_URL=$SUPABASE_URL
          NEXT_PUBLIC_SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
          ENV
            echo "Embedded Supabase runtime values into app bundle .env.local for launcher compatibility."
          else
            echo "Supabase runtime values missing in repo vars/secrets; app bundle .env.local not embedded."
          fi

          cd release_build/app
          zip -r ../../feh-app-bundle.zip app

      - name: Prepare bundled Node runtime (Windows x64)
        run: |
          NODE_VERSION=$(node -p "process.version")
          mkdir -p release_build/runtime
          cd release_build/runtime
          curl -L "https://nodejs.org/dist/${NODE_VERSION}/node-${NODE_VERSION}-win-x64.zip" -o node-win.zip
          unzip -q node-win.zip
          mv "node-${NODE_VERSION}-win-x64" node-runtime
          zip -r ../../feh-node-runtime.zip node-runtime

      - name: Prepare minimal assets bundle from repo-tracked data
        run: |
          mkdir -p release_build/assets/db
          cp db/index.json release_build/assets/db/index.json
          cd release_build/assets
          zip -r ../../feh-assets-bundle.zip db

      - name: Prepare runtime config bundle (Supabase auto-config)
        env:
          VAR_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
          VAR_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SECRET_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SECRET_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          SUPABASE_URL="$VAR_SUPABASE_URL"
          SUPABASE_ANON_KEY="$VAR_SUPABASE_ANON_KEY"

          if [ -z "$SUPABASE_URL" ]; then
            SUPABASE_URL="$SECRET_SUPABASE_URL"
          fi
          if [ -z "$SUPABASE_ANON_KEY" ]; then
            SUPABASE_ANON_KEY="$SECRET_SUPABASE_ANON_KEY"
          fi

          cat > feh-runtime-config.json <<JSON
          {
            "supabaseUrl": "$SUPABASE_URL",
            "supabaseAnonKey": "$SUPABASE_ANON_KEY"
          }
          JSON

          if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_ANON_KEY" ]; then
            echo "Created populated feh-runtime-config.json for automatic launcher setup."
          else
            echo "Created empty feh-runtime-config.json (no Supabase vars configured in repo settings)."
          fi

      - name: Release note for local full assets bundle
        run: |
          echo "Built feh-assets-bundle.zip from repo-tracked data only." >> RELEASE_NOTES.txt
          echo "For full local art assets, run: npm run build:local-assets-bundle on maintainer machine and upload replacement asset zip." >> RELEASE_NOTES.txt

      - name: Validate release target token requirements
        if: env.DISTRO_REPO != '' && env.DISTRO_REPO != github.repository && env.DISTRO_REPO_TOKEN == ''
        run: |
          echo "::error::DISTRO_REPO_TOKEN secret is required when FEH_DISTRO_REPO targets a different repository."
          exit 1

      - name: Attach release assets (same repo fallback)
        if: env.DISTRO_REPO == '' || env.DISTRO_REPO == github.repository
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            dist/FEH-Barracks-Launcher.exe
            feh-app-bundle.zip
            feh-node-runtime.zip
            feh-assets-bundle.zip
            feh-runtime-config.json
          generate_release_notes: true

      - name: Attach release assets (distribution repo)
        if: env.DISTRO_REPO != '' && env.DISTRO_REPO != github.repository && env.DISTRO_REPO_TOKEN != ''
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ env.DISTRO_REPO_TOKEN }}
          repository: ${{ env.DISTRO_REPO }}
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            dist/FEH-Barracks-Launcher.exe
            feh-app-bundle.zip
            feh-node-runtime.zip
            feh-assets-bundle.zip
            feh-runtime-config.json
          generate_release_notes: true
