name: Build Launcher Distribution Release

"on":
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      DISTRO_REPO: ${{ vars.FEH_DISTRO_REPO }}
      DISTRO_REPO_TOKEN: ${{ secrets.DISTRO_REPO_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install launcher dependencies
        run: npm ci --prefix launcher

      - name: Build launcher executable
        run: npm run build --prefix launcher

      - name: Prepare release bundles
        run: |
          mkdir -p release_build/app

          rsync -a \
            --exclude node_modules \
            --exclude .next \
            --exclude .env.local \
            app/ release_build/app/app/

          cd release_build/app
          zip -r ../../feh-app-bundle.zip app

      - name: Prepare bundled Node runtime (Windows x64)
        run: |
          NODE_VERSION=$(node -p "process.version")
          mkdir -p release_build/runtime
          cd release_build/runtime
          curl -L "https://nodejs.org/dist/${NODE_VERSION}/node-${NODE_VERSION}-win-x64.zip" -o node-win.zip
          unzip -q node-win.zip
          mv "node-${NODE_VERSION}-win-x64" node-runtime
          zip -r ../../feh-node-runtime.zip node-runtime

      - name: Prepare minimal assets bundle from repo-tracked data
        run: |
          mkdir -p release_build/assets/db
          cp db/index.json release_build/assets/db/index.json
          cd release_build/assets
          zip -r ../../feh-assets-bundle.zip db

      - name: Release note for local full assets bundle
        run: |
          echo "Built feh-assets-bundle.zip from repo-tracked data only." >> RELEASE_NOTES.txt
          echo "For full local art assets, run: npm run build:local-assets-bundle on maintainer machine and upload replacement asset zip." >> RELEASE_NOTES.txt

      - name: Validate release target token requirements
        if: env.DISTRO_REPO != '' && env.DISTRO_REPO != github.repository && env.DISTRO_REPO_TOKEN == ''
        run: |
          echo "::error::DISTRO_REPO_TOKEN secret is required when FEH_DISTRO_REPO targets a different repository."
          exit 1

      - name: Attach release assets (same repo fallback)
        if: env.DISTRO_REPO == '' || env.DISTRO_REPO == github.repository
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            dist/FEH-Barracks-Launcher.exe
            feh-app-bundle.zip
            feh-node-runtime.zip
            feh-assets-bundle.zip
          generate_release_notes: true

      - name: Attach release assets (distribution repo)
        if: env.DISTRO_REPO != '' && env.DISTRO_REPO != github.repository && env.DISTRO_REPO_TOKEN != ''
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ env.DISTRO_REPO_TOKEN }}
          repository: ${{ env.DISTRO_REPO }}
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            dist/FEH-Barracks-Launcher.exe
            feh-app-bundle.zip
            feh-node-runtime.zip
            feh-assets-bundle.zip
          generate_release_notes: true
